# 状态机模型

> 以股票买卖为例

1. 在`1`到`n`天中，每天有一个股票价格`w[i]`，sam可进行买卖，**同时最多持一股**，求最后最大获利

   > 贪心解法：股票的所有高买低卖都可以做到：`if (w[i] > w[i - 1]) ans += w[i] - w[i - 1];`

   + 对持股状态有如下自动机模型：

     ```mermaid
     graph LR; a((未持股0)); b((持股1)); a --买入--> b; b --卖出--> a; a --不动--> a; b --不动--> b;
     ```

   + 状态表示：$f_{i, j}表示第i天j状态的方案，其值为方案的最优值$

     状态计算：$\begin{cases} f_{i, 0} = max(f_{i - 1, 0}, f_{i - 1, 1} + w_i) &i天未持股的状态来自\begin{cases} i - 1 没有持股 \\ i - 1持股，i天卖出股票，收益加上i天的收益 \end{cases}  \\ f_{i, 1} = max(f_{i - 1, 1}, f_{i - 1, 0} - w_i) &i天持股的状态来自\begin{cases} i - 1 持股 \\ i - 1没有持股，i天买入股票，收益减去i天的花费 \end{cases} \end{cases}$

   ```c++
   memset(f, 0, sizeof f);
   f[0][1] = -INF;  //开始之前没有持股的状态
   for (int i = 1; i <= n; ++ i) {
       f[i][0] = max(f[i - 1][0], f[i - 1][1] + w[i]);
       f[i][1] = max(f[i - 1][1], f[i - 1][0] - w[i]);
   }
   //f[n][0]
   ```

2. 在原题的基础上限制总交易次数`k`（不大）（股票的一次买入卖出算一次交易）：

   + 增加一维表示已经交易的次数，其他不变

   + 自动机模型：注意由于买入和卖出算一次，所以从未持股到持股次数不变

     ```mermaid
     graph LR; a((未持股0)); b((持股1)); a --次数不变买入--> b; b --次数减一卖出--> a; a --次数不变不动--> a; b --次数不变不动--> b;
     ```

   + 状态表示：$f_{i, j, k}表示第i天花费交易次数j并且持股状态为k的方式，其值为方案的最优值$

     状态计算：$\begin{cases} f_{i, j, 0} = max(f_{i - 1, j, 0}, f_{i - 1, j - 1, 1} + w_i) \\ f_{i, j, 1} = max(f_{i - 1, j, 1}, f_{i - 1, j, 0} - w_i) \end{cases}$

   + 把状态转移放在自动机中：

     ```mermaid
     graph LR; a((0)); b((1)); a --"f(i - 1, j, 0) - w[i]"--> b; b --"f(i - 1, j - 1, 1) + w[i]"--> a; a --"f(i - 1, j, 0) + 0"--> a; b --"f(i - 1, j, 1) + 0"--> b;
     ```

   ```c++
   memset(f, -0x3f, sizeof f);
   f[0][0][0] = 0;
   
   for (int i = 1; i <= n; ++ i) {
       for (int j = 0; j <= k; ++ j) {
           f[i][j][0] = f[i - 1][j][0];
           if (j) f[i][j][0] = max(f[i][j][0], f[i - 1][j - 1][1] + w[i]);  //要有j
           f[i][j][1] = max(f[i - 1][j][1], f[i - 1][j][0] - w[i]);
       }
   }
   
   //max{f[n][][0]}
   ```

3. 在原题的基础上，约束在卖出股票后紧接着的第二天不能买入股票(一天冷冻期)，在约束的基础上尽可能多的完成交易，求最大利润

   + 状态增加：

     1. 持股                           ——1
     2. 不持股
        1. 在冷冻期            ——2
        2. 不在冷冻期        ——0

   + 状态机：

     ```mermaid
     graph LR; a((0)); b((1)); c((2)); 	
     	a --"f[i - 1][0] + 0"--> a; b --"f[i - 1][1] + 0"--> b;
     	a --"f[i - 1][0] - w[i]"--> b; b --"f[i - 1][1] + w[i]"--> c; c --"f[i - 1][2] + 0"--> a;
     ```

   ```c++
   memset(f, -0x3f, sizeof f);
   f[0][0] = 0;
   for (int i = 1; i <= n; ++ i) {
   	f[i][0] = max(f[i - 1][0], f[i - 1][2]);
       f[i][1] = max(f[i - 1][1], f[i - 1][0] - w[i]);
       f[i][2] = f[i - 1][1] + w[i];
   }  
   //max(f[n][0], f[n][2])
   ```
