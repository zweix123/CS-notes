# 网络层

+ 在TCP/TP体系中网络层常常被称为***网际层***(internet layer)，或IP层。

> （端到端：虚电路服务）网络层设计之初，想类似电话一样面向连接地通信方式。计算机通信时先建立连接——虚电路VC(Virtual Circuit)，这样在通信时地首部无需填写完整目的主机地址，而只需填写虚电路编号。——可以保证信息的传递，但交换器贵
>
> > OSI提供曾主张虚电路服务，也推出网络层需电报服务的标准——ITU-T的X.25建议书
>
> （无连接：数据报服务）互联网采用这样地设计思路：**网络层向上只提供简单灵活的、无连接的、尽最大努力交付的 （IP）*数据报*(datagram) / 分组 服务**——网络层不提供服务质量的承诺：可能储存、丢失、重复和失序，同时时限也不保证。但路由器便宜，由由主机中的运输层保证——网络造假大大降低，运行方式灵活，能够适应多种应用。
>
>  <img src="https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/虚电路服务和数据报服务的对比.png" style="zoom:79%;" />

+ 网际协议IP(Internet Protocol)

> 网际协议IP是TCP/IP体系中两个最重要的协议之一，也是最重要的互联网标准协议之一
>
> 网际协议IP又称Kahn-Cerf协议，现多使用IP的第四个版本：IPv4，也是用较新的IPv6（其它版本未曾使用）

+ 配套协议：
  + 地址解释协议ARP(Address Resolution Protocol)
  
    > 本有 逆地址解析协议(Reverse Address Resolution Protocol)与之配套使用，已淘汰
  
  + 网际控制报文协议ICMP(Internet Control Message Protocol)[RFC 792]
  
  + 网际组管理协议IGMP(Internet Group Management Protocol)
  
   <img src="https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/IP配套协议.png" style="zoom:80%;" />
  
+ 虚拟互连网络(internet)

  > 1. 世界上的网络是不同的，没有一种单一的网络能够适应所有用户的需求，各厂商也推出新网络
  >
  > 2. 网络互连需要*中间设备*：
  >
  >    + 物理层         ：转发器（repeater）
  >    + 数据链路层 ：网桥/桥接器（beidge）
  >    + 网络层         ：路由器（router）
  >    + 网络层以上 ：网关（gateway）
  >
  >    网关比较复杂，用的少，路由器就是专用计算机，由于利用原因，TCP/IP相关文献中网络层使用的路由器称为网关。

  + IP网：参加互连的的计算机都是用网际协议IP，把连接后的网络看作虚拟互连网络，即 逻辑互连网络，就是物理网络的异构型客观存在，但通过IP协议将各异的网络在网络层上看起来好像是一个统一的网络

  如果IP网覆盖全球就是互联网（Internet）

  + 好处：方便讨论：

     <img src="https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/IP网.png" style="zoom:70%;" />
  


## IP地址

> 整个互联网是一个单一的、抽象的网络，IP地址即为互联网上每台主机或路由器的每个接口的标识符。

+ IP地址 由 *互联网名字和数字分配机构ICANN*(Internet Corporation for Assigned Names and Numbers) 分配。
+ 编址方法的发展：
  1. 分类的IP地址：基本方式，1981通过相应标准协议
  2. 子网的划分   ：改进        ，1985通过标准RFC 950
  3. 构成超网       ：较新        ，1993提出 快速推广。

-----

**分类的IP地址**

+ 划分：两个字段：$IP地址 ::= {<网络号>, <主机号>}$ （符号$::=$表示“定义为“）

  1. 网络号(new-id)：在互联网内唯一
  2. 主机号(host-id)：在网络号范围内唯一

  继而一个IP地址在整个互联玩范围内唯一

  分类：

   <img src="https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/各类IP地址字段含义.png" style="zoom:80%;" />

  1. A类：单播地址（一对一通信）。
  2. B类：单播地址
  3. C类：单播                                   。网络号字段字长；前面的是*类别位*：内容固定；主机号字段字长
  4. D类：前四位1110，用于多播（一对多通信）
  5. E类：前四位1111，保留为后用

+ 书写：IP地址都是32位二进制，常在每8位中插入一个空格（机器中没有）；机器中使用*点分十进制法*(dotted decimal notation)：每八位化成十进制然后在空格位置加上点。

   <img src="https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/点分十进制法.png" style="zoom:75%;" />

**A、B、C类别的IP地址**：

+ 本网络(this)地址：网络号为全0，是保留地址
+ 环回地址：网络号除类别码全为1，指本机，用于*环回测试*(loopback test)

+ 本主机所在的单个网络地址：主机号全零
+ 本主机连接的所有(all)网络地址：主机号全1

![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/IP地址指派范围.png)

> 通过类别码可以找到，A类地址占整个IP地址空间的一半，剩下的空间B类地址占一半，即总的25%，相应的C。。。12.5%。

+ 一般不使用的特殊IP地址：

  ![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/特殊IP地址.png)

**IP地址的重要特点**

+ 分等级地址结构（网络号和主机号）：
  + 分层管理：IP地址管理机构把网络号分配给单位，单位自行分配主机号
  + 路由器仅根据目的主机所连接的网络号来转发分组，减少路由表所占的存储空间以及查表时间

+ IP地址标记的是主机和链路的接口
  + 多归属主机(multihomed host)：一台主机连接到多个网络
  + 路由器至少应当连接两个不同网络，所以路由器至少有两个不同的IP地址
+ 用转发器或网桥连接起来的若干个局域网仍为一个网络，它们有相同的网络号，不同网络号的局域网必须用路由器连接
+ 每个IP地址都是平等的。
  + 同一局域网上的主机或路由器的IP地址中的网络号必须一致
  + 用网桥互连的网段仍是一个局域网
  + 路由器总具有两个及以上的IP地址
  + 两个路由器直接相连时，接口否是分配IP地址是可选的
    1. 分配地址：这段连线是特殊的网络
    2. 不分配：（为节省资源），则称为*无编号网络*(unnumbered network)/*无名网络*(anonymous nerwork)[COME06]

**硬件地址**

+ + 硬件（物理）地址：是数据链路层和物理层使用的地址
  + IP地（逻辑）地址：是网络层和以上各层使用的地址。

+ ![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/IP地址嵌入到硬件地址.png)

  ![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/IP地址与硬件地址的层次划分.png)

  > 抽象分离，各管各的，互不可知，嵌套使用，分别修改

  + 在IP层抽象的互联网上只能看到IP数据报——在网络层讨论问题使用统一的IP地址研究通信

    路由器只根据目的站的IP地址的网络号进行路由选择

  + 在局域网的链路层，只能看见MAC帧：
    IP数据报被封装起来，在被路由器传递时，只修改MAC帧的源地址和目标地址

  + 在不同局域网的路由器中，会上升到网络层来分析和修改IP数据报，再下降到下层

### 其他编址方式

+ IP地址设计的不合理：
  1. IP地址空间的利用率低：公司不愿申请足够但是级别更低的类型地址网络号
  2. 网络号的设计可能使路由表变差：
     1. 太多：存储空间多
     2. 太多：查找时间长
     3. 太多：更新频率高
  3. 两级IP地址不灵活：先申请再开通

+ 解决思路：
  + 划分子网：类型不能变、网络号不能变、允许你那在主机号里再分分
  + 划分超网：直接取消阿巴阿巴的限制，随便分，反正就是个二叉树嘛

#### 划分子网

> 划分子网(subnetting)[RFC 950]/子网寻址/子网路由选择：在IP地址增加”子网号字段“，使之变为三级地址——为解决上述问题

+ 思路：

  1. 拥有多个物理网络的单位，将所属的物理网络划分为若干个子网；单位内部划分，对单位外透明，即对外仍是一个网络
  2. 从网络的主机号借若干位作为*子网号*(subnet-id)，对应着主机号减少同样的位数，使两级IP地址在**本单位内部**变成三级IP地址，记作：$IP地址 ::= \{ <网络号>, <子网号>, <主机号>\}$。
  3. 外界对该单位的数据报可以通过网络号找到该网，收到后处理交给对应主机

  只是再次划分，而未改变IP地址

+ 子网掩码(subnet mask)：解决在局域网中将IP数据报发给具体的子网

  > 从IP数据报的首部的源地址和目的地址无法看出，于是采用掩码

  ![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/子网掩码.png)

  + 默认子网掩码——对应类型的网络号长度

    <img src="https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/默认子网掩码.png" style="zoom:70%;" />

    子网掩码是一个网络或一个子网的重要属性：

    RFC 950之后，相邻路由器交换信息还需要交换子网掩码

  + 子网位数多，则子网数多，但每个子网的主机数就小——增加灵活性，但减少主机总数

    > 全0和全1的子网号谨慎使用

+ zweix：路由器在转发时通过掩码获取网络号

  ​              子网掩码就是一个从IP地址中获取主机号的算法

**使用子网时分组的转发**

1. 从IP数据报首部提取目标地址
2. 通过掩码获得目标网络地址
   1. 判断能否直接交付：
      1. 是否在本局域网
   2. 否则间接交付：
      1. 给特定主机路由
      2. 路由表其他路由
      3. 默认路由
3. 否则出错

#### 构造超网

> 问题：还是不够——2011.2.3，IANA宣布IPv4地址耗尽。
>
> 解决：
>
> 1. 变长子网掩码VLSM(Variable Length Subnet Mask)
> 2. 无分类域间路由选择**CIDR**(Classless Inter-Domain Routing)（读作”sider“）

+ 格式：$IP地址 ::= \{ <网络前缀>, <主机号> \}$

  > CIDR消除了传统的A类、B类和C类地址以及划分子网的概念。

  1. 前面部分：*网络前缀*(network-prefix)（简称”前缀“）：指明网络
  2. 后面部分：主机号

+ 特点：

  + CIDR记法：
    + *斜线记法*(slash notation)（**CIDR**记法）：在IP地址后加上斜线”/“，然后写上网络前缀的位数（可省略末尾0）
    + 二进制记法用星号*代替主机号部分

  + CIDR**地址块**：网络前缀相同的连续的IP地址

    + 路由聚合*(route aggregation)：上述地址的聚合                   即*构成超网)(supernetting)

    + *地址掩码*(address mask)       ：在路由选择中识别上述地址

      > 为与子网划分协调，也可称子网掩码

      + 网络前缀部分为1，主机号部分为0（在斜线记法中，斜线后面的数字就是地址掩码中1的个数）

  + 虽然“CIDR不使用子网”，但仍可以那样做

  + 最长前缀匹配(longest-prefis matching)/最长匹配/最佳匹配：下一跳地址

    + 查找算法：*二叉搜索*(binary trie) + *唯一前缀*(unique prefix)：
      1. 二叉搜索：tire树的一种
      2. 唯一前缀：把整个IP抽象成一个唯一的前缀做其值
      3. 唯一前缀内部再唯一前缀——压缩技术

### 其他类型地址

#### IPv6

> 20世纪70年代末设计IPv4；到2011.2，IPv4地址耗尽；IPv6[RFC 2460,4862,4443]草案

+ 变化：
  1. 更大的地址空间                       ：128位
  2. 扩展的地址层次结构               ：地址空间更大
  3. 灵活的首部格式                       ：与IPv4不兼容，因为多了可选首部
  4. 改进的选项                               ：IPv6首部长度固定，选项放在有效载荷中
  5. 允许协议继续扩充                   ：
  6. 支持即插即用（即自动配置）：IPv6不需要DHCP
  7. 支持资源的预分配                    ：
  8. 首部为8字节对齐（IPv4是4字节对齐）

**格式**：由*基本首部*(base header) + *有效载荷*(payload)/静载荷 = 若干*扩展首部*(extension header) + 数据部分;（扩展首部不属于IPv6数据报首部）

![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/IPv6一般格式.png)

+ 变化：

  + 取消首部长度字段，因为其首部长度固定

  + 取消服务类型字段，因为优先级和流标号实现同样功能

  + 取消总长度字段，改用有效载荷长度字段

  + 取消表示、标志和片偏移字段，这些功能已包含在分片扩展首部

  + 把TTL字段改为跳数限制字段，但作用一样

  + 取消检验和字段 -> 加快了速度

    > 运输层会对差错数据报进行处理，那网络层就不处理了

  + 取消选项字段，在扩展首部中实现

+ 字段：

  ![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/IPv6首部.png)

  1. 版本(version)：4位：指定协议版本，IPv6对应6

  2. 通信量类(traffic class)：8位：区分不同IPv6数据报类别或优先级

  3. 流标号(flow label)：20位：新的资源预分配机制，允许路由器把每个数据报与给定资源分配相联系

     > 流(flow)：互联网络上从特定源点到特点终点（单播或多播）的一系列数据报（如实时视频或视频传输）

     流所经过的路径上的路由器都保证指明的服务质量

     对于传统的电子邮件或非实时数据，流标号无用，设为0[RFC 6437]

  4. 有效载荷长度(payload length)：16位：指明除首部外的字节数，最大位64KB（65535字节）

  5. 下一个首部(next header)：8位，相当于IPv4的协议字段或可选字段

     + 当IPv6数据报没有扩展首部，此字段与IPv4协议字段一样：指出数据应交付上层哪个协议
     + 否则：表示后面第一个扩展首部的类型

  6. 跳数限制(hop limit)：8位：每次转发将其-1，防止数据报在网络中无限期存在

  7. 源地址    ：占128位：数据报发送端的IP地址

  8. 目的地址：占128位：数据报接收端的IP地址

  IPv4的诸多选项在每次转发路由器都要检查，IPv6将其放在扩展首部，只由终端主机处理，从而加速

  + 扩展首部类型：

    1. 逐跳选项
    2. 路由选择
    3. 分片
    4. 鉴别
    5. 封装安全有效载荷
    6. 目的站选项

    所有扩展首部的第一个字段都是8位的”下一个首部“字段

**地址**

+ 分类：
  1. 单播(unicast)    ：传统点对点
  2. 多播(multicast) ：一对多，广播认为是多播的特例
  3. 任播(anycast)    ：终点是一组计算机，但只交付给其中一个
+ 记法：冒号十六进制记法(colon lexadecimal natation, 简写为colon hex)：每16位用十六进制表示，用冒号分隔，允许省略前导0（但0000为0）
  + 零压缩(zero compression)：一连串连续的零可用一对冒号所取代，只能使用一次
  + 可结合使用点分十进制记法的后缀（冒号分隔16位，点分隔8位）
  + CIDR斜线表示法仍可用

![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/IPv6地址分类.png)

**从IPv4向IPv6过渡**

> 互联网规模太大，只能采用逐步演进的办法，还要让IPv6系统能够向后兼容
>
> 常用 双协议栈和隧道技术 [RFC 2473, 2529, 3056, 4038, 4213]

+ 双协议栈(dual stack)：指在完全过渡到IPv6之前，使部分主机装有双协议栈，记为IPv6/IPv4

  + 域名系统DNS：确定使用哪种协议

  在数据报的传输过程可能使字段损失

+ 隧道技术(tunneling)：将IPv6数据报直接作为IPv4数据报的数据部分来进入IPv4网络

  此时整个IPv4网络相当于一个”隧道“

  + 这样的IPv4数据报首部的协议字段的值设置为41

-------

+ ICMPv6：用于IPv6的返回差错信息

  >  与IPv4的ICMP的差别：把其他三个协议都合并：
  >
  > ![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/ICMPv6.png)

  + 在归类时，也将其他协议认为是ICMPv6
    1. 邻站发现ND(Neighbor-Discovery)报文/多播听众交付MLD(Multicast Listener Delivery)报文

#### IP多播

> 起始于1988Steve Deering的博士学位论文
>
> IP多播(multicast)，曾译为组播
>
> 参考[W-MCAST]

+ 优势：单播实现一对多通过多个副本，而多播只需要一个副本，只在网络分支时才复制

+ 多播路由器(multicast router)：能够运行多播协议的路由器

+ 多播主干网MBONE(Multicast Backbone On the InterNEt)：把分组传播给地点分散但属于一个组的许多主机

  > 1992起在互联网上开始试验

> 在互联网上的进行多播就是IP多播

+ 实现原理：通过IP地址中的D类地址，通过D类地址标志多播组，IP数据报的目的地址为D类地址，协议字段为2。显然多播不能用于源地址（单播），所以不能ping

1. 局域网的硬件多播
2. 互联网的范围进行多播

**局域网硬件多播**

![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/局域网硬件多播.png)

![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/D类IP地址与以太网多播地址的映射.png)

+ 所需协议：
  1. 网际组管理协议IGMP
  2. 多播路由选择协议

## IP数据报

**格式**：

![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/IP数据报格式.png)

+ 首部

  + 固定部分

    + 版本（占4位）：IP协议版本长度

    + 首部长度（占4位）：单位是32位字（字长4字节）；IP首部固定长度是20字节，所以首部长度最小是5；最大15，即60字节；当首部长度不是4字节的整数倍时，必须利用最后的填充字段进行**填充**

    + 区分服务（占8位）(旧称服务类型)：未被使用过；1998年IETF将此字段改为*区分服务*DS(Differentiated Services)[RFC 2474, 3168, 3260]，只在区分服务时才起作用

    + 总长度（占16位）：指首部和数据之和的长度，单位是字节；最大为$2 ^ {16} - 1 = 65535$字节

      > 链路层规定数据字段的最大长度——最大传送单元MTU——常用1500字节
      >
      > 如果传送的数据报长度超多MTU值，需要进行***分片***处理
      >
      > IP协议规定：在互联网中所有的主机和路由器，	必须能够接收长度不超过576字节的数据报（上层交下来的512，最长的IP首部60，和4字节的富余量）

    + 标识(identification)（占16位）：软件中的计数器，如果分片，每段数据报的标识都一样

    + 标志(flag)（占3位）：

      1. 最低位为MF(More Fragment)：当其等于1即标识”后面还有分片“
      2. 中间位为DF(Don't Fragment)：当其等于1即标识”不能分片“，为0才可以

    + 片偏移（占13位）：分片后每片在原分组的相对位置——相对与字段起点；以8字节位单位——每个分片的长度是8字节（64位）的整数倍

    + 生存时间（占8位）(Time To Live, TTL)：指数据报在网络中的寿命，防止其在网络中兜圈子

      > 旧使用以秒为单位，每经过路由则在TTL中减去相应秒数（小于1减1），减为0丢弃
      >
      > 现路由处理一般都远远小于1，故将其功能变为”*跳数限制*“——单位是跳数，即在互联网中可以经过多少个路由器，一般为144；若把TTl的初始值设置为1，则意味着这个数据报只能在本局域网中传送

    + 协议（占8位）：指此数据报携带的数据使用何种协议

      ![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/协议字段.png)

    + 首部检验和（占16位）：只检查数据报的首部，但不包括数据部分——为节省时间，算法很简单：

      1. 把首部分为16位序列，求和，此字段即为和的反码，
      2. 检验即为首部就和，为0认为正常，否则丢弃

    + 源地址（占32位）

    + 目的地址（占32位）

  + 可变部分：功能丰富，很少使用

+ 数据部分

**IP层转发分组流程**

> 如果路由器可以具体到每个网络中的每台主机，则路由表极大，所以路由表只记录路由器的（接口的）地址：能直接交付，即在该路由器接口的网络内，否则，间接交换——发送到对应的路由器。

+ 互联网上转发分组是由一个路由器转发到另一个路由器，即 基于主机所在的网络

  + 特定主机路由：特定的主机指明一个路由

  + 默认路由(default route)：

    当一个网络只有一个路由器与外界相连，那么对于外界来说，这个网络的主机可以直接标注，而不是再丢到互联网里让算法处理，这时，对于外界的主机，这些地址是明确的，单一的（这个路由器），而其他的设置为其他，即默认

> IP数据报的首部只有源地址和目标地址，没有**下一跳**的地址，处理方式是路由器通过IP地址找到下一跳的IP地址，然后ARP找到这个路由器的硬件地址，填入MAC帧，如此往复。

+ 分组转发算法：

  1. 从数据报中得到目的主机的IP地址，得出目的网络地址
  2. 如果目标网络与该路由器直接相连，则直接交付（通过ARP找到目的主机硬件地址，把数据报封装到MAC帧，再发送），否则间接交付——到3
  3. 若路由表中有目的网络的地址的特定主机路由，则指明其为下一跳路由器，否则到4
  4. 若路由表中有目的网络的地址的可达路由，则指明其为下一跳路由器，否则到5
  5. 若路由表中有默认路由，则指明其为下一跳路由器，否则到6
  6. 报告转发分组出错

  不直接确定路线，走一步看一步。

## 路由器

+ 路由器是一种具有多个输入端口和多个输出端口的专用计算机，其任务是转发分组

+ 结构部分：

  ![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/经典路由器结构.png)

  1. 路由选择部分/控制部分：核心构件：路由选择处理机：根据路由选择协议构造路由表

     ​                                                                                              定期和相邻路由器交换路由信息而更新维护路由表

     + 为使交换功能分散化，把复制的转发表放在每一个输入端口，路由选择处理及负责对各转发表的副本进行更新，这些副本称为*影子副本*(shadow dopy)

  2. 分组转发部分：一组端口，是硬件接口，在路由器的*线路接口卡*上

     1. 交换结构(switching fabric)/交换组织：根据*转发表*(forwarding table)对分组进行处理/转发
     2. 输入端口
     3. 输出接口

     + 转发方式：

       ![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/交换方式.png)

       1. 通过存储器    ：受到存储器的带宽（读或写）的线速

          机器一个一个处理

       2. 通过总线        ：

          分组一个一个来

       3. 通过互连网络：纵横交换结构(crossbar switch fabric)：$2N$条总线

          多个地方多个路

  > + 转发        ：只涉及一个路由器
  >
  >   路由选择：涉及很多个路由器
  >
  >   路由表：多路由器协同工作的结果：网络的拓扑：仅有下一跳的IP地址
  >
  >   转发表：由路由表得出                   ：转发的选择：还有MAC地址
  >
  >   一般不区分
  >
  > + 线速(line speed/wire speed)：线路把分组传送到路由器的速率
  >
  > + 时延：输入和输出的时间不一样，本质是队列，如果堆积至超过队列存储空间溢出时则分组丢失。

## 路由选择

+ 理想的路由算法：获得路由表中的各项目

  + 特点：实际算法尽可能接近理想而已

    1. 算法必须是正确的和完整的               ：按照路由表比可达终点

    2. 算法在计算上应简单                           ：别有太多额外开销

    3. 算法能适应通信量和网络拓扑的变化：自适应性/稳健性(robustness) ：通信量变化，自适应改变以均衡各链路负载

       > 自动控制界的标准译名是“鲁棒性”、计算机是健壮性、[MINGC194]如此翻译。

    4. 算法应具有稳定性                            ：通信量和网络拓扑稳定，则算法解收敛，而不是不断变化

    5. 算法应是公平的                                ：

    6. 算法应是最佳的                                 ：

       > 所谓”最佳“只能是相对于某一种特定要求下得出的较为合理的选择而已

  + 划分（以特点3为标准）：

    + 静态路由选择策略/非自适应路由选择：简单开销小、不能适应网络的变化
    + 动态路由路由策略/自适应路由选择    ：复杂开销大、能适应网络的变化

+ 分层次的路由选择协议：自适应（/动态）的、分布式路由选择协议

  > 分层设计原因：1. 互联网的规模非常大; 2. 单位机密。

  将这个互联网划分为许多较小的*自治系统*(autonomous system, AS)：单一技术管理下的一组路由器，这些路由器使用系统内的路由选择协议和共同的度量；对外是一个单一的和一致的路由选择策略[RFC 4271]

  > ISP就是一个AS

  + 路由选择协议分类：
    1. ***内部网关协议***IGP(Interior Gateway Protcol)     ：AS内的，ege：RIP、OSPF
    2. ***外部网关协议***EGP(External Gateway Protocol)：不同AS之间的，ege：BGP-4
  + 路由选择分类：
    1. 域内路由选择(interdomain routing)
    2. 域间路由选择(intradomain routing)
  
  > + 互联网早期RFC文档未使用“路由器”而使用“网关”，但在新的RFC文档又使用“路由器”。故IGP、EGP -> RP、ERP
  >
  > + IGP和EGP本是协议类别
  >
  >   但      EGP又是协议名字，其后又被BGP取代

### RIP协议

1. **内部网关协议RIP**：路由信息协议RIP(Routing Informationg Protocol)：内部网关IGP的一种，是一种分布式的基于距离向量的路由选择协议

+ 内容：要求网络中的每一个路由器都维护从它到其他每个目的网络的距离记录——一组距离，即距离向量。

  > 距离（跳数，hop count）的定义：
  >
  > + 从一路由器到直接连接的网络的距离定义为1；
  > + 从一路由器到非直接连接的网络的距离定义为所经过的路由器数+1

  RIP认为好的路由就是通过的路由器的数目少，即距离短，RIP允许一条路径最多包含15个路由器，即距离等于16时则相当于不可达——RIP适用于小型互联网

  RIP只承认路径上的路由数量，即使另外一条是高速的

+ 特点：

  1. 仅和相邻路由器交换信息
  2. 路由器交换的信息是当前本路由器所知道的全部信息，即自己现在的路由表
  3. 按固定的时间间隔交换路由信息

+ 距离向量算法（Bellman-Ford算法）：路由器交换后更新的方式

  1. 对地址X的相邻路由器发来的RIP报文：到目的网络N、距离d、下一跳路由器X

     1. 先修改此报文重的所有项目：把“下一跳”字段中的地址都改为X，并把距离字段加1

  2. 对修改后的RIP报文中的每一个项目：

     1. 若原来的路由表没有目的网络N，则把该项目添加到路由表中

     2. 否则

        1. 若下一跳路由器地址是X，则把收到项目替换原路由表中的项目——更新的

        2. 否则——不是X，另一个路径

           1. 若收到的项目中的距离d小于路由表中的距离，则更新——更小值

           2. 否则

              什么都不做

     3. 若3分钟还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达的路由器，即把距离设置为16（即不可达）

+ 报文格式：

  > 较新的RIP版本是1998.11发布的RIP2[RFC 2453]，较于RIP1无太大变化，但性能上有所改进，可支持变长子网掩码和无分类路由选择CIDR，还提供简单的鉴别过程支持多播

  ![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/RIP2报文格式.png)

  1. 首部：4字节：命令字段指出报文含义

  2. 路由部分：若干路由信息组成，每个路由信息要20字节

     1. 地址族标识符/地址类别：标志所使用的地址协议——IP地址则该字段为2
     2. 路由标记填入自治系统号ASN(Autonomous System Number)

     一个RIP报文最多可包括25个路由——RIP报最大长度$4 + 20 * 25 = 504$字节

  + 鉴别功能：原路由信息位置用作鉴别：地址族标识设为全1，路由标记写入鉴别类型，剩下16字节作为鉴别数据。之后可再写写入路由信息（最多24个）

+ 优势：

  + 实现简单，开销较小

+ 缺点：

  + 限制了网络的规模——最大距离为15（16不可达）

  + 当网络出现故障时，要经过较长的时间才能将此信息传送到所有的路由器（好消息传播的快，而坏消息传播得慢）：

    > 当网络出现问题时，离它最近得路由器（相邻路由器）确实知道，但是其他的（其他路由器）不知道，继续发送数据报，而相邻路由器在收到消息后误以为其他路由器有到达出现问题网络的路径，于是照此修改自己的路径，并把修改后的信息发出去，收到的其他路由器误以为相邻路由器也都知道，于是照此修改自己的路径，只有最后每个路由器的记录都是距离很远时才意识到，不通。

### OSPF协议

2. **内部网关协议OSPF**：开放最短路径优先OSPF(Open Shortest Path First)

   > 为克服RIP的缺点在1989年开发，原理简单，实现复杂

   + ”开放“：OSPF协议不是受某一家厂商控制
   + ”最短路径优先“：使用Dijkstra提出的最短路径算法SPF

   > OSPF的第二个版本OSPF2已成为互联网标准协议[RFC 2328]

+ 使用分布式的*链路状态协议*(link state prtocol)

  1. 向本自治系统重**所有**路由器发送消息（洪泛法(flooding)）

  2. 发送的信息就是与本路由器相邻的所有路由器的链路状态

     > 链路状态：该路由器与哪些路由器相邻，以及*度量*(metric)/代价（费用、距离、时延、带宽， 可有网络管理人员决定）

  3. 只有当链路状态发生变化时，路由器才向所有路由器用泛洪法发送此消息

  + 所有路由器建立*链路状态数据路*(link-state database)，即全网的拓扑结构图（全网一致——链路状态数据库的同步）——与RIP不知道全网的拓扑结构所不同。
  + 更新过程收敛得快
  + 建立过程：见数据报格式

+ OSPF将自治系统再划分为若干更小的范围——*区域*(area)—为使其用于更大网络

  每个区域有一个32位区域标识符（点分十进制表示），每个区域内路由器不超200个

  把泛洪法局限在每个区域，减少整个网络上的通信量

+ 层次结构的区域划分：上层区域+下层区域

  + 主干区域(backbone area)：标识符为`0.0.0.0`：连接其它下层区域。

  + | 路由器种类                          | 功能                       |
    | ----------------------------------- | -------------------------- |
    | 主干路由器(backbone router)         | 主干区域内的路由器         |
    | 区域边界路由器(area dorder rounter) | 区域与其他区域连接的路由器 |
    | 自治系统边界路由器                  | 自治系统与外界连接的路由器 |

+ 特点：

  1. OSPF对于不同类型的业务可计算出不同的路由

     链路的代价可以是1至65535中的任何一个无量纲的数

     > 比如卫星对于长距离的代价小，但是对低时延的代价高

     RIP只是跳数

  2. 负载平衡：多个最短路，其上通信量相似

     RIP

+ 数据报格式：OSPF不使用UDP而是直接使用IP数据报传送（协议字段值为89）

  ![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/OSPF数据报格式.png)

  0. 使用24字节的固定长度首部
  1. 版本：当前的版本号为2
  2. 类型：可以是五种类型分组种的一种
     1. 问候(Hello)分组                                                        ：发现和维持邻站的可达性
     2. 数据库描述(Database Description)分组               ：向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息
     3. 链路状态请求(Link State Request)分组                 ：向对方请求发送某些链路状态项目的详细信息
     4. 链路状态更新(Link State Update)分组                  ：用泛洪法对全网更新链路状态，有五种链路状态[RFC 2328]
     5. 链路状态确认(Link State Acknowledgment)分组：对链路更新分组的确认
  3. 分组长度：包括OSPF首部在内的分组长度，以字节为单位
  4. 路由器标识符：标志发送该分组的路由器的接口的IP地址
  5. 区域标识符：分组属于的区域的标识符
  6. 检验和：用来检测分组种的差错
  7. 鉴别类型：目前只有两种，0（不用）和1（口令）
  8. 鉴别：鉴别类型为0时就填入0，鉴别类型为1则填入8字符的口令
  
+ 说明：

  + 相邻路由器每10秒交换问候分组来确定可达，如果40秒没有回应认为不可达，则修改数据库。

  + 同步：不用路由器的链路状态数据库的内容是一样的，认为其是*完全相邻的*(fully adjacent)路由器

  + 建立过程：

    1. 问候分组确定周围
    2. 描述分组查漏补缺
    3. 请求分组完善数据库
    4. 确认分组有始有终

    + 重复2、3、4

    5. 更新分组处理变化

    + 泛洪法：bfs发送 -> 确认分组回溯

      相应网络变化的时间小于100ms

  + 对多点接入的局域网采用*指定路由器*(designated router)方法

### BGP协议

+ 1989年，发布外部网关协议——边界网关协议BGP，后续更新为BGP-4[RFC 4271]

+ 背景：

  1. 互联网的规模太大，是的自治系统AS之间路由选择非常困难

     1. Dij算法会很慢
     2. 小——代价 >< 大——可达 ： 的矛盾

  2. 自治系统AS之间的路由选择必须考虑有关策略

     与政治、安全或经济方面有关：有的自治系统不愿意经过自己、国内的数据报不经过外国

+ 算法：路径向量(path vector)路由选择协议：寻找一条**比较好**的路由而**非最佳**路由

  0. 每个自治系统的管理员选择**至少**一个路由器作为该自治区的*BGP发言人*，**往往是**BGP边界路由器
  1. BGP发言人与其他AS通过TCP连接（端口179）建立BGP会话(session)作为对方的邻站(neighbor)或对等站(peer)来处理路由变化
  2. 抽象AS形成树形结构

+ 报文

  + 格式：![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/BGP报文结构.png)
    1. 通用首部：
       1. 标记(marker)：16字节；鉴别收到的BGP报文，如果不使用，全置为7
       2. 长度               ：2字节  ；包括首部在内的整个BGP报文以字节为单位长度（19~4096）
       3. 类型               ：1字节  ；报文类型（1~4）

  + 分类：

    1. OPEN（打开）报文               ：与相邻发言人建立关系，初始化通信

       格式：类型值为4

       1. 版本               ：1字节；现在4

       2. 本自治系统号：2字节；全球使用16位自治系统号，由ICANN地区等级机构分配

       3. 保持时间        ：2字节；以秒计算的保持位邻站关系的时间

       4. BGP标识符    ：4字节：该路由器IP地址

       5. 可选参数长度：1字节

          可选参数

    2. UPDATE（更新）报文           ：通告信息：宣告（一条）或撤销（若干条）路由

       格式：

       1. 不可行路由长度：2字节                                                                         ；指明下一个字段的长度

          撤销的路由                                                                                              ：列出所要撤销的路由

       2. 路径属性总长度：2字节                                                                         ；指明下一个字段的长度

          路径属性                                                                                                  ：定义在这个报文中增加的路径的属性

       3. 网络层可达性信息NLRI(Network Layer Reachability Information)：定义网络：前缀位数、IP地址前缀

    3. KEEPALIVE（保活）报文       ：周期性（30秒）证实邻站的连通性

       格式：19字节长——只是用首部

    4. NOTIFICATION（通知）报文：用来发送检测到的差错

       格式：

       1. 差错代码    ：1字节：
       2. 差错子代码：1字节：
       3. 差错数据    ：          ：给出差错的诊断信息

# 配套协议

+ 配套协议：

  + 地址解释协议ARP(Address Resolution Protocol)

    > 本有 逆地址解析协议(Reverse Address Resolution Protocol)与之配套使用，已淘汰

  + 网际控制报文协议ICMP(Internet Control Message Protocol)

  + 网际组管理协议IGMP(Internet Group Management Protocol)

   <img src="https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/IP配套协议.png" style="zoom:80%;" />

## 地址解析协议ARP

> + IP协议使用ARP协议来从网络层的IP地址，解析出数据链路层使用的硬件地址
>
>   故也有将ARP协议划分在数据链路层
>
> + 旧有协议 逆地址解析协议RARP，是 使只知道自己硬件地址的主机可以找到其IP地址
>
>   现 DHCP协议已包含此功能

+ 作用：获取**同一局域网**上的主机和路由器的IP地址和硬件地址的映射

> 每台主机设有*ARP高速缓存*(ARP cache)，会有本局域网各主机和路由器的IP地址和硬件地址的映射表，但不好（网络中主机的加入（入网）和撤走，自己刚加电）
>
> 在发送信息时，如果映射表有自然就发送，否则需要一定方法获取
>
> + 高速缓存映射表中的项目都设置了*生存空间*
>
>   > 因为如果对方硬件出现问题，就会更换，原地址失效，如果删除了就会重新发送

+ 流程：分组具体格式见[COME06]
  + 单局域网：
    1. ARP进程在本局域网上**广播**发送一个ARP请求分组（包括自己的IP和硬件地址，以及目标IP地址的硬件地址）
    2. 本局域网上的所有主机运行的ARP进程收到此分组
    3. 当本主机与分组中的目标IP地址一致时，则**收下**（也记录下请求分组的信息）分组，并发送ARP**响应**分组（自己的IP地址和硬件地址）（**单播**）
    4. 发送主机收到接收主机响应分组后，在其ARP高速缓存中写入B的IP地址到硬件地址的映射
  + 多个网络：通过路由器：
    1. 主机通过ARP找到对应路由器
    2. 路由器通过若干此ARP找到目标主机所在的局域网
    3. 最终到达目标主机
+ 意义：异构的网络的硬件地址差别很大，如果不通过抽象的IP地址，只使用硬件地址进行寻找，比较复杂，而现在只需要按照抽象唯一的IP地址进行寻找，然后定位底层硬件地址

+ 


## 网际控制报文协议ICMP

+ 目的：更新路由表

+ ICMP报文格式：

  ![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/ICMP报文格式.png)

  + 种类：

    + ICMP差错报告报文
    + ICMP询问报文

  + ![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/常用ICMP报文类型.png)

    + 询问报文现在少用

    > 下列说明主体都是路由器或主机

    1. 终点不可达               ：不能交付时发送
    2. 时间超过                   ：
       1. 数据报生存时间为0丢弃该报后发送
       2. 终点规定时间内没有收到完整数据报，丢弃已有，并向源点发送
    3. 参数问题                   ：首部不正确，丢弃，发送
    4. 改变路由（重定向）：路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（可通过更好的路由）

  + 差错报告报文格式：

    ![](https://cdn.jsdelivr.net/gh/zweix123/CS-notes@master/source/Computer-Network/ICMP差错报告报文格式.png)

  + 不应发送ICMP差错报告报文的情况：

    1. 对ICMP差错报告报文，不再发送ICMP差错报告报文
    2. 对第一个分片的数据报片的所有后续数据报片，都不发送ICMP差错报告报文
    3. 对具有多播地址的数据报，都不发送ICMP差错报告报文
    4. 对具有特殊地址的数据报，不发送ICMP差错报告报文

  + ICMP询问报文

    1. 回送    请求和回答：主机或路由器向特定目的主机发送询问、要求回送回答报文，来测试是否可达
    2. 时间戳请求和回答：请某台主机或路由器回答当前日期时间（32位字段，写入整数代表1900.1.1至此多少秒）

+ 应用：

  + 分组网间探测PING(Packet InterNet Groper)-ping：测试主机间连通性，其原理就是使用ICMP回送请求与回送回答报文，是应用层直接使用网络层ICMP而没有通过运输层的TCP或UDP

  + traceroute（UNIX）/tracert（Windowx）：跟踪一个分组从源点到终点的路径

    原理：

    + 源主机向目的主机发送一连串的IP数据报（封装无法交付的UDP用户数据报）并通过调节数据报生存时间TTL来还原路径

    1. 将第**一**个数据报的生存时间TTL设置为**1**，则其会在路径的第**一**个路由器被丢弃，而该主机也会向源主机发送一个**ICMP时间超过差错报告报文**
    2. 将第**二**个数据报的生存时间TTL设置为**2**，则其会在路径的第**二**个路由器被丢弃，而该主机也会向源主机发送一个**ICMP时间超过差错报告报文**
    3. 三3三时间超过差错

    + 直到刚好到目的主机，而IP数据报中封装的是无法交付的运输层的UDP数据报，故目的主机向源主机发送**ICMP终点不可达差错报告报文**

## 网际组管理协议IGMP

+ 网际组管理协议IGMP(Internet Group Management Protocol)

# 其他

==《计算机网络》谢希仁190-200==

## 虚拟专用网VPN

## 网络地址转换NAT

## 多协议标记交换MPLS
