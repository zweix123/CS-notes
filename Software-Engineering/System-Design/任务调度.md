+ Ref:
    + https://mp.weixin.qq.com/s/fAzH8SOWnocshMX3CB6OMw


# 引言

考虑下面几种业务场景：
1. 12306根据车型的不同，分成多个时间分批放票。
2. 财务系统在每天凌晨零点结算前一天的财务数据汇总统计。
3. 购物系统的订单要求半小时以内付款，否则到点取消订单。
4. 银行系统在信用卡还款到期日的前三天进行短信提醒。
5. 为实现实时天气效果，每隔五分钟访问天气服务器。

参考这些业务场景，理解什么是调度呢？我认为其本质是：通过某些**策略**去触发某些**事件**。

那么如何评估一个调度系统的好坏呢？有哪些指标呢？
+ 业务指标：
    + 能支持的策略类型：
        1. 单次：立刻执行，未来多少时间后执行，未来某个时刻执行。
        2. 周期：每隔五分钟，每隔半小时，每隔三个月。
        3. 定时：每天上午九点，每周一，每月的第一天。
    + 能支持的事件类型：最灵活的事件类型就是支持用户通过编程语言实现，比如部分调度系统提供SDK，服务按照SDK要求实现对应的业务逻辑提供接口，然后平台按照策略触发；一般是平台提供某种形式规范构建事件。
+ 性能指标：
    + 任务吞吐：
        + 任务调度具有瞬发性的特点，某个时间可能需要执行的任务更多（比如凌晨零点）。
    + 调度时效/延迟
        + 比如任务要求某一个特定时刻执行，怎么实际执行时间距离该时间尽可能小。
        + 比如业务需要任务的调度周期特别短（为什么不换成服务内部的守护进程呢）。
    + 任务资源公平性

# 核心问题与解决方案

## 基本业务能力实现

首先区分两个概念
+ 任务定义：包括但不限于任务的执行策略以及任务的执行行为的**信息**。
+ 任务实例：按照任务定义生成的一个会在特定时间执行的实例；具有状态，比如是否执行，比如执行是否成功，比如重试次数。

一般来说，一个任务调度系统可以由以下几个步骤/部分组成：

1. 任务生成：按照任务定义生成会在未来某个时间点执行的一个或者多个任务实例，比如单次执行的任务在创建任务定义时生成任务实例，比如任务在即将执行时生成下次执行的任务实例，比如小时纬度周期执行的任务在每天零点创建今天一天的任务实例。
2. 任务存储：任务存储主要是被任务触发的部分调用的，形态上需要支持根据任务实例执行时间的范围查询；同时还要关注查询的性能。
3. 任务触发：本质是将任务实例从任务存储读取到机器实例的内存中，一般是周期性的去加载未来一段时间需要执行的任务实例。可以想象，这里的加载周期与调度精度有关。
4. 任务执行：顾名思义，当任务触发时，去执行任务。假如事件是某种平台约束的形式，可能是平台提供机器去执行；假如事件是客户通过SDK实现在自己的服务中，可能会触发对应的服务执行。

以上流程在所有的调度系统中（无论是单体的还是集群的）均存在，只是形式可能不同。

比如：
+ Quartz中：会有一个线程不断的轮训，获取需要执行（未来一定时间）的任务列表，获取后则修改任务下次执行时间；然后就分别开一个线程去执行任务，这个过程按阶段修改任务状态。在这个流程中，这个线程本身就是任务触发，在触发的同时完成任务生成的工作（下次执行的时间），任务存储则是在内存（Quartz支持外部存储），任务执行则是开一个线程去做。

### 触发执行解偶

一般来说，支持分布式的系统，均采用任务触发和任务执行模块解偶的；将前者定义为**调度模块**，将后者定义为**执行模块**。避免耦合在一起时调度模块资源被执行模块占用，从而影响调度模块性能，降低调度模块可承载的任务量上限。

## 任务存储

在调度系统中，对存储系统主要看重以下特性
1. 范围查询效率
2. 查询的QPS

在这样的要求下，Redis和MySQL均可以支持

|        | Redis       | MySQL    |
| ------ | ----------- | -------- |
| 底层数据结构 | 有序集ZSet使用跳表 | 存储层使用B+树 |
|        |             |          |

### Redis

+ 大Key问题：分片分桶

## 任务触发

1. 分布式锁：
    + 为什么需要分布式锁呢？为了避免任务重复执行，调度模块同时只有一个机器实例在调度。
2. 扫描间隔：与系统性能和精度相关。

### 分布式锁问题

1. MySQL的行锁
2. Redis通过lua脚本实现锁
3. ZooKeeper选举

## 任务执行

+ 调度模块选择合适的执行模块的一个实例进行触发
    1. 通过负载均衡
    2. 通过消息队列解偶

# 业界典型实现与发展

|      | Quartz         | XXL-Job | Elastic-Job | ScheduleX |
| ---- | -------------- | ------- | ----------- | --------- |
| 评价   | Java事实上的定时任务标准 |         |             | 商业系统      |
| 类型   | 框架             | 系统      | 框架          |           |
| 是否开源 | 开源             | 开源      | 开源          | 商用        |

# 附录

## Cron和Cron表达式

> [cron(wiki)](https://en.wikipedia.org/wiki/Cron)

cron是一个命令行程序，按照配置文件（crontab）生成守护进程使任务在固定的时间、日期或者间隔定期执行。
其中配置文件内容的格式就是使用Cron表达式，其标准如下：
```
# * * * * * * <command to execute>
# | | | | | |
# | | | | | year (optional)
# | | | | day of the week (0–6) (Sunday to Saturday; 
# | | | month (1–12)             7 is also Sunday on some systems)
# | | day of the month (1–31)
# | hour (0–23)
# minute (0–59)
```

标准cron表达式除了最后的命令本身，是由五位或者六位表示对应时间的参数表示
> 以上是标准cron表达式，业界存在部分扩展，不过一般主体不变。

上面的位可以通过使用数字表示执行某一个时间。
而且还可以通过`*`表示统配、`,`划分多个数字表示并且，`-`表示范围，部分扩展标准还能通过`/n`指定间隔。

下面是一些示例
```
0/5 * * * * ...    # 每隔五分钟执行一次, 这个与周期任务不完全一样, 这里的执行时间点应该是类似0, 5, 10, 15这样的，而周期5分钟去执行则只保证间隔是5分钟，但不一定是整点（虽然几乎所有业务场景整点都可以cover后者）
0,30 * * * *  ...  # 每小时的0分和30分执行一次, 相当于间隔半小时触发
0 8-12 * * * *  .. # 每天的8点到12点每小时的0点执行一次
```

结论：cron表达式在定时性调度策略上具有很强的表意能力，绝大部分下也能cover周期性的策略；甚至一般建议将周期性的策略转换成定时性的策略，比如每半小时执行的策略转换成每小时的0分和30分执行一次（当然一般情况下两者并没有业务上的差别，后者反而更可能造成与其他任务的撞车）

# 参考

+ [微信公众号 · 腾讯技术工程 · 高性能调度系统设计总结](https://mp.weixin.qq.com/s/fAzH8SOWnocshMX3CB6OMw)
+ [微信公众号 · 得物技术 · Go-Job让你的任务调度不再繁琐｜得物技术](https://mp.weixin.qq.com/s/24UZVu-yrXwIt_YWn9txTg)
+ [轻风博客 · 如何设计一个海量任务调度系统](https://www.cnblogs.com/88223100/p/How-to-Design-a-Massive-Task-Scheduling-System.html)
+ [XXL开源社区 · 【任务调度】分布式对任务调度的几点要求](https://www.xuxueli.com/blog/?blog=./notebook/8-%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84%E4%B8%8E%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%9B%BE%E8%B0%B1/2-%E7%90%86%E8%AE%BA%E7%AF%87/2.1%E3%80%81%E3%80%90%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E3%80%91%E5%88%86%E5%B8%83%E5%BC%8F%E5%AF%B9%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%9A%84%E5%87%A0%E7%82%B9%E8%A6%81%E6%B1%82.md)
+ [博客园 · 勇哥Java实战 · 实现一个任务调度系统，看这篇文章就够了](https://www.cnblogs.com/makemylife/p/15838776.html)
+ [腾讯云 · 码猿技术专栏 · 聊聊 分布式任务调度框架 xxl-job](https://cloud.tencent.com/developer/article/2277093)
+ [Freedium · bugfree.ai · System Design Interview with a Meta Staff Engineer: Designing a Task Scheduler](https://freedium.cfd/medium.com/@bugfreeai/system-design-interview-with-a-meta-staff-engineer-designing-a-task-scheduler-1a5041b4860e)
